<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><title>oauth框架搭建 | BLOG</title><meta name="description" content="oauth框架搭建"><meta name="keywords" content="java,框架,oauth"><meta name="author" content="周凌宇,15823217944@163.com"><meta name="copyright" content="周凌宇"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="canonical" href="httpS://zly1024.github.io/2019/07/22/oauth框架搭建/"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="oauth框架搭建"><meta name="twitter:description" content="oauth框架搭建"><meta name="twitter:image" content="httpS://zly1024.github.io/img/avatar.png"><meta property="og:type" content="article"><meta property="og:title" content="oauth框架搭建"><meta property="og:url" content="httpS://zly1024.github.io/2019/07/22/oauth框架搭建/"><meta property="og:site_name" content="BLOG"><meta property="og:description" content="oauth框架搭建"><meta property="og:image" content="httpS://zly1024.github.io/img/avatar.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="prev" title="HEXO 新手搭建教程" href="httpS://zly1024.github.io/2019/07/23/HEXO-新手搭建教程/"><link rel="next" title="Hello World" href="httpS://zly1024.github.io/2019/07/22/hello-world/"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://jerryc.me/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  highlight_copy: 'true',
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  bookmark: {
    title: 'Bookmark',
    message_prev: 'Press',
    message_next: 'to bookmark this page'
  },
  runtime_unit: 'days'

  
}</script></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#oauth2总结"><span class="toc-number">1.</span> <span class="toc-text"> oauth2总结</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#前言"><span class="toc-number">1.1.</span> <span class="toc-text"> 前言</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-什么是oauth"><span class="toc-number">1.1.0.1.</span> <span class="toc-text"> 1. 什么是oauth</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-运行流程图"><span class="toc-number">1.1.0.2.</span> <span class="toc-text"> 2. 运行流程图</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-四种授权模式"><span class="toc-number">1.1.0.3.</span> <span class="toc-text"> 3. 四种授权模式</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-授权码模式"><span class="toc-number">1.1.0.3.1.</span> <span class="toc-text"> 1. 授权码模式</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-密码模式"><span class="toc-number">1.1.0.3.2.</span> <span class="toc-text"> 2. 密码模式</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-客户端模式"><span class="toc-number">1.1.0.3.3.</span> <span class="toc-text"> 3. 客户端模式</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-简化模式"><span class="toc-number">1.1.0.3.4.</span> <span class="toc-text"> 4. 简化模式</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-oauth授权服务器搭建"><span class="toc-number">1.1.0.4.</span> <span class="toc-text"> 4. oauth授权服务器搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-创建springboot工程并引入oauth相关依赖"><span class="toc-number">1.1.0.4.1.</span> <span class="toc-text"> 1. 创建springboot工程并引入oauth相关依赖</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-oauthconfig配置"><span class="toc-number">1.1.0.4.2.</span> <span class="toc-text"> 2. OauthConfig配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-authenticationprovider实现类"><span class="toc-number">1.1.0.4.3.</span> <span class="toc-text"> 3. AuthenticationProvider实现类</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-websecurityconfig-配置"><span class="toc-number">1.1.0.4.4.</span> <span class="toc-text"> 4. WebSecurityConfig 配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-授权码生成实现类authorizationcodeservices"><span class="toc-number">1.1.0.4.5.</span> <span class="toc-text"> 5. 授权码生成实现类AuthorizationCodeServices</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-资源服务器搭建"><span class="toc-number">1.1.0.5.</span> <span class="toc-text"> 5. 资源服务器搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-引入依赖"><span class="toc-number">1.1.0.5.1.</span> <span class="toc-text"> 1. 引入依赖</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-resourceserverconfig-配置"><span class="toc-number">1.1.0.5.2.</span> <span class="toc-text"> 2. ResourceServerConfig 配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-websecurityconfig-配置"><span class="toc-number">1.1.0.5.3.</span> <span class="toc-text"> 3. WebSecurityConfig 配置</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-认证授权全流程过程以及源码分析"><span class="toc-number">1.1.0.6.</span> <span class="toc-text"> 6. 认证授权全流程过程以及源码分析</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1第一步登陆认证"><span class="toc-number">1.1.0.6.1.</span> <span class="toc-text"> 1.第一步：登陆认证</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2第二步授权"><span class="toc-number">1.1.0.6.2.</span> <span class="toc-text"> 2.第二步：授权</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3第三步鉴权"><span class="toc-number">1.1.0.6.3.</span> <span class="toc-text"> 3.第三步：鉴权</span></a></li></ol></li></ol></li></ol></li></ol></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/Photo/post.png)"><div id="page-header"><span class="pull-left"> <a class="blog_title" id="site-name" href="/">BLOG</a></span><div class="open toggle-menu pull-right"><div class="menu-icon-first"></div><div class="menu-icon-second"></div><div class="menu-icon-third"></div></div><span class="pull-right menus"><div class="mobile_author_icon"><img class="lozad" data-src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'"><div class="mobile_author-info__description">静态博客简易搭建</div></div><hr><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a><script>document.body.addEventListener('touchstart', function(){ });</script></div></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search fa-fw"></i><span> Search</span></a></span></div><div id="post-info"><div id="post-title"><div class="posttitle">oauth框架搭建</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> Created 2019-07-22<span class="post-meta__separator">|</span><i class="fa fa-history" aria-hidden="true"></i> Updated 2019-07-23</time><span class="post-meta__separator mobile_hidden">|</span><span class="mobile_hidden"><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/技术/">技术</a></span></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><h1 id="oauth2总结"><a class="markdownIt-Anchor" href="#oauth2总结"></a> oauth2总结</h1>
<h2 id="前言"><a class="markdownIt-Anchor" href="#前言"></a> 前言</h2>
<h4 id="1-什么是oauth"><a class="markdownIt-Anchor" href="#1-什么是oauth"></a> 1. 什么是oauth</h4>
<p>OAuth（开放授权）是一个开放标准，允许用户让第三方应用访问该用户在某一网站上存储的私密的资源（如照片，视频，联系人列表），而无需将用户名和密码提供给第三方应用。</p>
<h4 id="2-运行流程图"><a class="markdownIt-Anchor" href="#2-运行流程图"></a> 2. 运行流程图</h4>
<p><img src="https://pic.yupoo.com/zly1024/29f7bc05/24491604.jpg" alt="yunxingliucheng"></p>
<p>（A）用户打开客户端以后，客户端要求用户给予授权。</p>
<p>（B）用户同意给予客户端授权。</p>
<p>（C）客户端使用上一步获得的授权，向认证服务器申请令牌。</p>
<p>（D）认证服务器对客户端进行认证以后，确认无误，同意发放令牌。</p>
<p>（E）客户端使用令牌，向资源服务器申请获取资源。</p>
<p>（F）资源服务器确认令牌无误，同意向客户端开放资源。</p>
<h4 id="3-四种授权模式"><a class="markdownIt-Anchor" href="#3-四种授权模式"></a> 3. 四种授权模式</h4>
<h5 id="1-授权码模式"><a class="markdownIt-Anchor" href="#1-授权码模式"></a> 1. 授权码模式</h5>
<p>授权码模式是四种模式中最繁琐也是最安全的一种模式。</p>
<p>client向资源服务器请求资源，被重定向到授权服务器（AuthorizationServer）</p>
<p>浏览器向资源拥有者索要授权，之后将用户授权发送给授权服务器</p>
<p>授权服务器将授权码（AuthorizationCode）转经浏览器发送给client</p>
<p>client拿着授权码向授权服务器索要访问令牌</p>
<p>授权服务器返回Access     Token和Refresh Token给cilent</p>
<p>这种模式是四种模式中最安全的一种模式。一般用于client是Web服务器端应用或第三方的原生App调用资源服务的时候。因为在这种模式中AccessToken不会经过浏览器或移动端的App，而是直接从服务端去交换，这样就最大限度的减小了AccessToken泄漏的风险。</p>
<p>1.获取授权码请求uri：/oauth/authorize</p>
<p>参数：</p>
<ul>
<li>
<p>client_id：客户端id。</p>
</li>
<li>
<p>response_type：授权类型，此值固定为“code”。</p>
</li>
<li>
<p>redirect_uri：成功授权后的回调地址</p>
</li>
</ul>
<p>2.获取token请求uri：/oauth/token</p>
<p>参数:</p>
<ul>
<li>client_id：客户端id。</li>
<li>client_secret：客户端密钥</li>
<li>grant_type：授权类型，固定为authorization_code</li>
<li>code：授权码</li>
<li>redirect_uri：重定向地址</li>
</ul>
<h5 id="2-密码模式"><a class="markdownIt-Anchor" href="#2-密码模式"></a> 2. 密码模式</h5>
<p>用户将认证密码发送给client</p>
<p>client拿着用户的密码向授权服务器请求Access Token</p>
<p>授权服务器将Access Token和Refresh Token发送给client</p>
<p>这种模式十分简单，但是却意味着直接将用户敏感信息泄漏给了client，因此这就说明这种模式只能用于client是我们自己开发的情况下。因此密码模式一般用于我们自己开发的，第一方原生App或第一方单页面应用。</p>
<p>1.获取token请求uri：/oauth/token</p>
<p>参数：</p>
<ul>
<li>username：用户名</li>
<li>password：用户密码</li>
<li>client_id：客户端id</li>
<li>client_secret：客户端密钥</li>
<li>grant_type：授权类型，固定为password</li>
</ul>
<h5 id="3-客户端模式"><a class="markdownIt-Anchor" href="#3-客户端模式"></a> 3. 客户端模式</h5>
<p>这是一种最简单的模式，只要client请求，我们就将AccessToken发送给它。</p>
<p>client向授权服务器发送自己的身份信息，并请求AccessToken</p>
<p>确认client信息无误后，将AccessToken发送给client</p>
<p>这种模式是最方便但最不安全的模式。因此这就要求我们对client完全的信任，而client本身也是安全的。因此这种模式一般用来提供给我们完全信任的服务器端服务。在这个过程中不需要用户的参与。</p>
<p>1.获取token请求uri：/oauth/token</p>
<p>参数：</p>
<ul>
<li>client_id：客户端id</li>
<li>client_secret：客户端密钥</li>
<li>grant_type：授权类型，固定为client_credentials</li>
</ul>
<h5 id="4-简化模式"><a class="markdownIt-Anchor" href="#4-简化模式"></a> 4. 简化模式</h5>
<p>简化模式相对于授权码模式省略了，提供授权码，然后通过服务端发送授权码换取AccessToken的过程。</p>
<p>client请求资源被浏览器转发至授权服务器</p>
<p>浏览器向资源拥有者索要授权，之后将用户授权发送给授权服务器</p>
<p>授权服务器将AccessToken以Hash的形式存放在重定向uri的fargment中发送给浏览器</p>
<p>浏览器访问重定向URI</p>
<p>资源服务器返回一个脚本，用以解析Hash中的AccessToken</p>
<p>浏览器将Access Token解析出来</p>
<p>将解析出的Access Token发送给client</p>
<p>一般简化模式用于没有服务器端的第三方单页面应用，因为没有服务器端就无法使用授权码模式。</p>
<p><strong>注：一般使用前三种模式</strong></p>
<h4 id="4-oauth授权服务器搭建"><a class="markdownIt-Anchor" href="#4-oauth授权服务器搭建"></a> 4. oauth授权服务器搭建</h4>
<p>版本：</p>
<ul>
<li>springboot：1.4.5</li>
<li>security：1.4.5</li>
<li>oauth2：2.0.13</li>
<li>redis：4.0</li>
</ul>
<h5 id="1-创建springboot工程并引入oauth相关依赖"><a class="markdownIt-Anchor" href="#1-创建springboot工程并引入oauth相关依赖"></a> 1. 创建springboot工程并引入oauth相关依赖</h5>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.security.oauth<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-security-oauth2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--jwttoken依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.security<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-security-jwt<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--oauth客户端详情数据库存取相关依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.41<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="2-oauthconfig配置"><a class="markdownIt-Anchor" href="#2-oauthconfig配置"></a> 2. OauthConfig配置</h5>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@EnableAuthorizationServer</span></span></span><br><span class="line"><span class="comment"> * 工具方法，用来在当前应用context里(必须是一个DispatcherServlet context)</span></span><br><span class="line"><span class="comment"> * 开启一个授权server(例如AuthorizationEndpoint)和一个TokenEndpoint。</span></span><br><span class="line"><span class="comment"> * server的多个属性可以通过自定义AuthorizationServerConfigurer类型</span></span><br><span class="line"><span class="comment"> * (如AuthorizationServerConfigurerAdapter的扩展)的Bean来定制</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@EnableAuthorizationServer</span></span><br><span class="line"><span class="meta">@AutoConfigureAfter</span>(WebSecurityConfig.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OAuth2Config</span>  <span class="keyword">extends</span> <span class="title">AuthorizationServerConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//AuthenticationManager为认证入口的接口</span></span><br><span class="line">    <span class="comment">//通过该接口可以获得用户相关信息、安全实体的标识以及认证请求的上下文信息</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AuthenticationManager authenticationManager;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DataSource dataSource;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisCacheProperties redisCacheProperties;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserDetailsService userDetailsService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AuthenticationProvider authenticationProvider;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;jwt.store.password:zaq12wsx&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String jwtPass;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//jwtToken转换bean 替换oauth默认生成的token</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JwtAccessTokenConverter <span class="title">jwtAccessTokenConverter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        JwtAccessTokenConverter converter = <span class="keyword">new</span> JwtAccessTokenConverter();</span><br><span class="line">        KeyPair keyPair = <span class="keyword">new</span> KeyStoreKeyFactory(</span><br><span class="line">                <span class="keyword">new</span> ClassPathResource(<span class="string">"jwt.jks"</span>), <span class="string">"zaq12wsx"</span>.toCharArray())</span><br><span class="line">                .getKeyPair(<span class="string">"jwt"</span>);</span><br><span class="line">        converter.setKeyPair(keyPair);</span><br><span class="line">        <span class="keyword">return</span> converter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//jedis连接工厂bean</span></span><br><span class="line">    <span class="meta">@Bean</span>(<span class="string">"connection4jwt"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> JedisConnectionFactory <span class="title">jedisConnectionFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        JedisPoolConfig jedisPoolConfig = <span class="keyword">new</span> JedisPoolConfig();</span><br><span class="line">        jedisPoolConfig.setMaxWaitMillis(redisCacheProperties.getMaxWaitMillis());</span><br><span class="line">        jedisPoolConfig.setMaxIdle(redisCacheProperties.getMaxIdle());</span><br><span class="line">        jedisPoolConfig.setMaxTotal(redisCacheProperties.getMaxTotal());</span><br><span class="line"></span><br><span class="line">        JedisConnectionFactory factory = <span class="keyword">new</span> JedisConnectionFactory(jedisPoolConfig);</span><br><span class="line">        factory.setHostName(redisCacheProperties.getHost());</span><br><span class="line">        factory.setPort(redisCacheProperties.getPort());</span><br><span class="line">        factory.setDatabase(<span class="number">1</span>);</span><br><span class="line">        factory.setPassword(redisCacheProperties.getPassword());</span><br><span class="line">        factory.afterPropertiesSet();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> factory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置Token  redis存储bean</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> TokenStore <span class="title">tokenStore</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        RedisTokenStore redisTokenStore = <span class="keyword">new</span> RedisTokenStore(jedisConnectionFactory());</span><br><span class="line">        redisTokenStore.setPrefix(<span class="string">"auth-server.jwt"</span>);</span><br><span class="line">        <span class="keyword">return</span> redisTokenStore;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置基于数据库的客户端详情存取</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(ClientDetailsServiceConfigurer clients)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        clients.jdbc(dataSource);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//用来配置授权（authorization）以及令牌（token）的访问端点和令牌服务(token services)。</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthorizationServerEndpointsConfigurer endpoints)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        endpoints.authenticationManager(authenticationManager)</span><br><span class="line">                .accessTokenConverter(jwtAccessTokenConverter())<span class="comment">//配置jwt转换器</span></span><br><span class="line">                .authorizationCodeServices(<span class="keyword">new</span> AuthorizationCodeServices(dataSource))<span class="comment">//配置授权码</span></span><br><span class="line">                .tokenStore(tokenStore()).reuseRefreshTokens(<span class="keyword">false</span>)<span class="comment">//配置token存储</span></span><br><span class="line">                .userDetailsService(userDetailsService);<span class="comment">//配置基于数据库验证账户密码</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//oauth获取token，鉴权token的逻辑都在DefaultTokenServices中，它实现了两个接口</span></span><br><span class="line">        <span class="comment">//AuthorizationServerTokenServices ：创建，刷新，获取访问令牌</span></span><br><span class="line">        <span class="comment">//ResourceServerTokenServices ：加载凭据，获取token的详情</span></span><br><span class="line">        <span class="comment">// 构建TokenServices</span></span><br><span class="line">        TokenServices tokenServices = <span class="keyword">new</span> TokenServices();</span><br><span class="line">        tokenServices.setTokenStore(tokenStore());</span><br><span class="line">        tokenServices.setSupportRefreshToken(<span class="keyword">true</span>);</span><br><span class="line">        tokenServices.setReuseRefreshToken(<span class="keyword">false</span>);</span><br><span class="line">        <span class="comment">//从数据库获取client详情</span></span><br><span class="line">        tokenServices.setClientDetailsService(endpoints.getClientDetailsService());</span><br><span class="line">        tokenServices.setTokenEnhancer(jwtAccessTokenConverter());</span><br><span class="line"></span><br><span class="line">        endpoints.tokenServices(tokenServices);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//用来配置令牌端点(Token Endpoint)的安全约束.</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthorizationServerSecurityConfigurer oauthServer)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        oauthServer.tokenKeyAccess(<span class="string">"permitAll()"</span>).checkTokenAccess(</span><br><span class="line">                <span class="string">"isAuthenticated()"</span>).allowFormAuthenticationForClients();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ProviderManager 为AuthenticationManager 的认证实现类</span></span><br><span class="line">    <span class="comment">//认证方法authenticate()</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    认证流程：1.封装UsernamePasswordAuthenticationToken（主要是将用户输入的用户名密码进行封装，并提供				给AuthenticationManager进行验证，验证成功后，返回一个认证成功的									UsernamePasswordAuthenticationToken对象）设置用户未认证</span></span><br><span class="line"><span class="comment">    		2.ProviderManager.authenticate() 轮询成员变量List&lt;AuthenticationProvider&gt; 					providerList，只要其supports函数返回true，就执行该AuthenticationProvider的authenticate</span></span><br><span class="line"><span class="comment">    		方法，验证成功后重新组装UsernamePasswordAuthenticationToken，并设置用户已认证</span></span><br><span class="line"><span class="comment">    		</span></span><br><span class="line"><span class="comment">    		注，若要自定义认证方式，则实现AuthenticationProvider接口即可</span></span><br><span class="line"><span class="comment">    **/</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ProviderManager <span class="title">authenticationManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;AuthenticationProvider&gt; providerList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        providerList.add(authenticationProvider);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ProviderManager(providerList);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>DefaultTokenServices详解：</strong><a href="https://www.jianshu.com/p/1fba33b26976" target="_blank" rel="noopener">https://www.jianshu.com/p/1fba33b26976</a></p>
<p><strong>AuthenticationManager 详解</strong>：<a href="https://www.cnblogs.com/xuwenjin/p/9565356.html" target="_blank" rel="noopener">https://www.cnblogs.com/xuwenjin/p/9565356.html</a></p>
<h5 id="3-authenticationprovider实现类"><a class="markdownIt-Anchor" href="#3-authenticationprovider实现类"></a> 3. AuthenticationProvider实现类</h5>
<p>核心代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Authentication <span class="title">authenticate</span><span class="params">(Authentication authentication)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line">    String userName = authentication.getName();</span><br><span class="line">    String password = (String) authentication.getCredentials();</span><br><span class="line">    UserDetails userDetails = userDetailsService.loadUserByUsername(userName);</span><br><span class="line">    <span class="keyword">if</span> (userDetails == <span class="keyword">null</span>) &#123;</span><br><span class="line">        logger.debug(<span class="string">"Authentication failed: user doesn't exists!"</span>);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> BadCredentialsException(<span class="keyword">this</span>.messages.getMessage(<span class="string">"AbstractUserDetailsAuthenticationProvider.badCredentials"</span>, <span class="string">"Bad credentials"</span>));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        String userPassWord = userDetails.getPassword();</span><br><span class="line">        <span class="keyword">if</span> (userPassWord.equals(password) || userPassWord.equals(PasswordUtil.encodePassword(password, userName)) ||</span><br><span class="line">                userPassWord.equals(PasswordUtil.encodePassword(passwordMd5Encode(password), userName))) &#123;</span><br><span class="line">            <span class="comment">//校验用户是否已过期或被锁住等</span></span><br><span class="line">            <span class="keyword">if</span> (UserLoginHoldUtil.canUserLoginByAuth(userDetails)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> UsernamePasswordAuthenticationToken(userDetails, password, userDetails.getAuthorities());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                logger.debug(<span class="string">"Authentication failed: user cannot login!"</span>);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> BadCredentialsException(<span class="keyword">this</span>.messages.getMessage(<span class="string">"AbstractUserDetailsAuthenticationProvider.badCredentials"</span>, <span class="string">"Bad credentials"</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            logger.debug(<span class="string">"Authentication failed: password does not match stored value!"</span>);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BadCredentialsException(<span class="keyword">this</span>.messages.getMessage(<span class="string">"AbstractUserDetailsAuthenticationProvider.badCredentials"</span>, <span class="string">"Bad credentials"</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="4-websecurityconfig-配置"><a class="markdownIt-Anchor" href="#4-websecurityconfig-配置"></a> 4. WebSecurityConfig 配置</h5>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * WebSecurityConfigurerAdapter是默认情况下spring security的http配置</span></span><br><span class="line"><span class="comment"> 其过滤器链默认值为100</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="comment">//指定的类加载完了再加载本类</span></span><br><span class="line"><span class="meta">@AutoConfigureAfter</span>(AuthProviderConfig.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;security.success.defaultTargetUrl:&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String defaultTargetUrl;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AuthenticationProvider authenticationProvider;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//security本身是有认证页面的，这里设置security的成功失败的路径等等</span></span><br><span class="line">        SimpleUrlLogoutSuccessHandler logoutSuccessHandler = <span class="keyword">new</span> SimpleUrlLogoutSuccessHandler();</span><br><span class="line">        logoutSuccessHandler.setTargetUrlParameter(<span class="string">"redirect_uri"</span>);</span><br><span class="line"></span><br><span class="line">        SavedRequestAwareAuthenticationSuccessHandler successHandler = <span class="keyword">new</span> SavedRequestAwareAuthenticationSuccessHandler();</span><br><span class="line">        successHandler.setTargetUrlParameter(<span class="string">"redirect_uri"</span>);</span><br><span class="line">        successHandler.setDefaultTargetUrl(defaultTargetUrl);</span><br><span class="line"></span><br><span class="line">        http.httpBasic().disable().csrf().disable().logout().logoutSuccessHandler(logoutSuccessHandler).and().formLogin().loginPage(<span class="string">"/login"</span>).successHandler(successHandler).defaultSuccessUrl(defaultTargetUrl).permitAll().and().authorizeRequests()</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">            此处是设置哪些http请求通过，哪些http请求需要被认证，</span></span><br><span class="line"><span class="comment">            ResourceServerConfigurerAdapter中的http设置会跟web中的功能一样</span></span><br><span class="line"><span class="comment">     		不过ResourceServerConfigurerAdapter的过滤器链默认执行顺序为3</span></span><br><span class="line"><span class="comment">            **/</span></span><br><span class="line">                .antMatchers(<span class="string">"/oauth/**"</span>).permitAll()</span><br><span class="line">                .antMatchers(<span class="string">"/register"</span>, <span class="string">"/usr/verifyUserName"</span>, <span class="string">"/usr/sendVerifyCode"</span>, <span class="string">"/usr/register"</span>).permitAll()</span><br><span class="line">                .antMatchers(<span class="string">"/fp_phone"</span>, <span class="string">"/fp_reset"</span>, <span class="string">"/usr/fp/verifyPhoneEffect"</span>, <span class="string">"/usr/fp/resetPwd"</span>).permitAll()</span><br><span class="line">                .antMatchers(<span class="string">"/MP_verify_RIPzMyhi7TAhrr1q.txt"</span>).permitAll()   <span class="comment">//保证微信内不提示安全验证信息</span></span><br><span class="line">                .anyRequest().authenticated();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//security认证配置，使用自定义的认证类</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        auth.authenticationProvider(authenticationProvider);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>ResourceServerConfigurerAdapter 与WebSecurityConfigurerAdapter 对比详解</strong>：<a href="https://www.jianshu.com/p/fe1194ca8ecd" target="_blank" rel="noopener">https://www.jianshu.com/p/fe1194ca8ecd</a></p>
<h5 id="5-授权码生成实现类authorizationcodeservices"><a class="markdownIt-Anchor" href="#5-授权码生成实现类authorizationcodeservices"></a> 5. 授权码生成实现类AuthorizationCodeServices</h5>
<p>核心代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">createAuthorizationCode</span><span class="params">(OAuth2Authentication authentication)</span> </span>&#123;</span><br><span class="line">    String code = generator.generate();</span><br><span class="line">    store(code, authentication);</span><br><span class="line">    <span class="keyword">return</span> code;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>继承于默认实现类JdbcAuthorizationCodeServices：存储code于数据库表oauth_code中，删除code</p>
<p>又继承于默认实现类RandomValueAuthorizationCodeServices</p>
<h4 id="5-资源服务器搭建"><a class="markdownIt-Anchor" href="#5-资源服务器搭建"></a> 5. 资源服务器搭建</h4>
<h5 id="1-引入依赖"><a class="markdownIt-Anchor" href="#1-引入依赖"></a> 1. 引入依赖</h5>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.security.oauth<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-security-oauth2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.security<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-security-jwt<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="2-resourceserverconfig-配置"><a class="markdownIt-Anchor" href="#2-resourceserverconfig-配置"></a> 2. ResourceServerConfig 配置</h5>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 资源服务配置.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> zly</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">资源服务器通过 <span class="doctag">@EnableResourceServer</span> 注解来开启一个 OAuth2AuthenticationProcessingFilter 类型的过滤器</span></span><br><span class="line"><span class="comment">解析令牌的方法</span></span><br><span class="line"><span class="comment">1.使用 DefaultTokenServices 在资源服务器本地配置令牌存储、解码、解析方式</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="meta">@EnableResourceServer</span></span><br><span class="line"><span class="meta">@ConditionalOnProperty</span>(name = <span class="string">"security.enabled"</span>, havingValue = <span class="string">"true"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResourceServerConfig</span> <span class="keyword">extends</span> <span class="title">ResourceServerConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*每个服务依赖时资源id为应用名字*/</span></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;spring.application.name:spring-boot-application&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String resourceId;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;jwt.store.password:zaq12wsx&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String jwtPass;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(ResourceServerSecurityConfigurer resources)</span> </span>&#123;</span><br><span class="line">        resources.resourceId(resourceId);<span class="comment">//（必须配）</span></span><br><span class="line">        <span class="comment">//资源服务配置tokenServices（非必须）</span></span><br><span class="line">        resources.tokenServices(defaultTokenServices());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        http.requestMatcher(<span class="keyword">new</span> OAuthRequestedMatcher()).authorizeRequests().antMatchers(HttpMethod.OPTIONS).permitAll()</span><br><span class="line">                .anyRequest().authenticated();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserDetailsService <span class="title">userDetailsService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> OAuthUserDetailsService();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//DefaultAccessTokenConverter又使用DefaultUserAuthenticationConverter来做用户密码角色相关</span></span><br><span class="line">    <span class="comment">//若为非对称加密必须配</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JwtAccessTokenConverter <span class="title">jwtAccessTokenConverter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        JwtAccessTokenConverter converter = <span class="keyword">new</span> JwtAccessTokenConverter();</span><br><span class="line">        KeyPair keyPair = <span class="keyword">new</span> KeyStoreKeyFactory(</span><br><span class="line">                <span class="keyword">new</span> ClassPathResource(<span class="string">"jwt.jks"</span>), jwtPass.toCharArray())</span><br><span class="line">                .getKeyPair(<span class="string">"jwt"</span>);</span><br><span class="line">        converter.setKeyPair(keyPair);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//可不配置</span></span><br><span class="line">        DefaultAccessTokenConverter accessTokenConverter = <span class="keyword">new</span> DefaultAccessTokenConverter();</span><br><span class="line"></span><br><span class="line">        DefaultUserAuthenticationConverter userAuthenticationConverter = <span class="keyword">new</span> DefaultUserAuthenticationConverter();</span><br><span class="line">        userAuthenticationConverter.setUserDetailsService(userDetailsService());</span><br><span class="line"></span><br><span class="line">        accessTokenConverter.setUserTokenConverter(userAuthenticationConverter);</span><br><span class="line">        converter.setAccessTokenConverter(accessTokenConverter);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> converter;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//若不配置会使用内存存储（则无法解析）</span></span><br><span class="line">    <span class="comment">//配置jwtTokenStore，解析token用到的是jwtAccessTokenConverter</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> TokenStore <span class="title">tokenStore</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        JwtTokenStore tokenStore = <span class="keyword">new</span> JwtTokenStore(jwtAccessTokenConverter());</span><br><span class="line">        <span class="keyword">return</span> tokenStore;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//（非必须）</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResourceServerTokenServices <span class="title">defaultTokenServices</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> DefaultTokenServices defaultTokenServices = <span class="keyword">new</span> DefaultTokenServices();</span><br><span class="line">        defaultTokenServices.setTokenEnhancer(jwtAccessTokenConverter());</span><br><span class="line">        defaultTokenServices.setTokenStore(tokenStore());</span><br><span class="line">        <span class="keyword">return</span> defaultTokenServices;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//（非必须）</span></span><br><span class="line">    <span class="comment">//http请求过滤</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">OAuthRequestedMatcher</span> <span class="keyword">implements</span> <span class="title">RequestMatcher</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">            String auth = request.getHeader(<span class="string">"Authorization"</span>);</span><br><span class="line">            <span class="comment">// Determine if the client request contained an OAuth Authorization</span></span><br><span class="line">            <span class="keyword">boolean</span> haveOauth2Token = (auth != <span class="keyword">null</span>) &amp;&amp; StringUtils.startsWithIgnoreCase(auth, <span class="string">"Bearer"</span>);</span><br><span class="line">            <span class="keyword">boolean</span> haveAccessToken = request.getParameter(<span class="string">"access_token"</span>) != <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">return</span> haveOauth2Token || haveAccessToken;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>ResourceServerConfig详解</strong>：<a href="https://www.jianshu.com/p/6dd03375224d" target="_blank" rel="noopener">https://www.jianshu.com/p/6dd03375224d</a></p>
<h5 id="3-websecurityconfig-配置"><a class="markdownIt-Anchor" href="#3-websecurityconfig-配置"></a> 3. WebSecurityConfig 配置</h5>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> zly</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="meta">@EnableGlobalMethodSecurity</span>(prePostEnabled = <span class="keyword">true</span>,securedEnabled = <span class="keyword">true</span>)</span><br><span class="line"><span class="comment">//@EnableGlobalMethodSecurity(prePostEnabled = true)</span></span><br><span class="line"><span class="meta">@ConditionalOnProperty</span>(name = <span class="string">"security.enabled"</span>, havingValue = <span class="string">"true"</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        http.cors().and()</span><br><span class="line">                .authorizeRequests()</span><br><span class="line">                .antMatchers(HttpMethod.OPTIONS).permitAll()</span><br><span class="line">                .antMatchers(<span class="string">"/wxAdapter"</span>, <span class="string">"/wxAdapter/*"</span>).permitAll()</span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line">                .and().httpBasic()</span><br><span class="line">                .and().csrf().disable();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最好的放开方式，resourceServerConfig中不配置请求过滤，在security的配置中使用，因为security在</p>
<p>yml文件里有已存在的标签来控制。</p>
<p><img src="https://pic.yupoo.com/zly1024/5b7a5a18/bd0c469f.png" alt="securityyml标签"></p>
<h4 id="6-认证授权全流程过程以及源码分析"><a class="markdownIt-Anchor" href="#6-认证授权全流程过程以及源码分析"></a> 6. 认证授权全流程过程以及源码分析</h4>
<h5 id="1第一步登陆认证"><a class="markdownIt-Anchor" href="#1第一步登陆认证"></a> 1.第一步：登陆认证</h5>
<p>用户访问受限的资源服务页面,页面判断code的存在跳转到授权服务器登陆页面（我的redirect_uri设置为localhost：8083，即我资源服务器地址为localhost：8083)，请求url为：</p>
<p><a href="http://localhost:9999/oauth/authorize?response_type=code&amp;client_id=shopapp&amp;redirect_uri=http://localhost:8083" target="_blank" rel="noopener">http://localhost:9999/oauth/authorize?response_type=code&amp;client_id=shopapp&amp;redirect_uri=http://localhost:8083</a></p>
<p>获取code时先判断用户是否已认证：</p>
<p><img src="https://pic.yupoo.com/zly1024/cd77c661/61ba5b43.png" alt="获取code"></p>
<p><img src="https://pic.yupoo.com/zly1024/259df8b8/6e7090ef.png" alt="登陆认证页面"></p>
<p>security认证入口：</p>
<p><img src="https://pic.yupoo.com/zly1024/982422bb/a14838cd.png" alt="登陆认证入口"></p>
<p>Authentication.authenticate():默认实现类ProvideManager</p>
<p><img src="https://pic.yupoo.com/zly1024/1d292eed/7e819532.png" alt="登陆认证_1"></p>
<p>此类有一个成员变量List<authenticationprovider> providerList = new ArrayList&lt;&gt;();</authenticationprovider></p>
<p>最后执行的是AuthenticationProvider.authenticate();下图是自定义的AuthenticationProvider对象</p>
<p><img src="https://pic.yupoo.com/zly1024/38c377e8/5202f7d0.png" alt="登陆认证_2"></p>
<p>登陆认证完成之后会返回Authentication对象（实现类UsernamePasswordAuthenticationToken），然后会将对象中的password清除</p>
<p><img src="https://pic.yupoo.com/zly1024/dd239b3e/9e47219c.png" alt="登陆认证_3"></p>
<p>最后会将对象存入SecurityContext中</p>
<p><img src="https://pic.yupoo.com/zly1024/d68fa496/b7404e76.png" alt="登陆认证出口"></p>
<p>之后会再次回到获取code的接口中，生成code，然后oauth会跳转到redirect_uri并带上code和state参数。</p>
<h5 id="2第二步授权"><a class="markdownIt-Anchor" href="#2第二步授权"></a> 2.第二步：授权</h5>
<p>在资源页面js中根据code和redirect_uri手动构造请求访问授权服务器获取token</p>
<p><img src="https://pic.yupoo.com/zly1024/fbdae2f9/aed8403f.png" alt="获取token"></p>
<p><img src="https://pic.yupoo.com/zly1024/52445771/97ab73de.png" alt="oauth授权入口"></p>
<p>经过校验传递的参数是否合法之后，会进入到TokenGranter接口-----&gt;AbstractTokenGranter抽象类的grant()方法获取token</p>
<p><img src="https://pic.yupoo.com/zly1024/55256eb2/7ecd752d.png" alt="获取token_1"></p>
<p>最终的执行方法是DefaultTokenServices.createAccessToken()</p>
<p><img src="https://pic.yupoo.com/zly1024/f62cc138/6f73ff39.png" alt="获取token_2"></p>
<p><img src="https://pic.yupoo.com/zly1024/fceb3bfe/3a6a6c01.png" alt="获取token_3"></p>
<p>若DefaultTokenServices中配置了TokenEnhance会执行其enhance方法替换之前生成的token格式</p>
<p>一般是配置jwtAccessTokenConverter</p>
<p><img src="https://pic.yupoo.com/zly1024/c0209a6d/7a180306.png" alt="获取token_4"></p>
<p>生成token成功之后会返回ResponseEntity<oauth2accesstoken>对象，最终返回给前端，存入localstage或页面其他地方。</oauth2accesstoken></p>
<p><img src="https://pic.yupoo.com/zly1024/70fb8fbf/33538ab2.png" alt="认证授权成功"></p>
<h5 id="3第三步鉴权"><a class="markdownIt-Anchor" href="#3第三步鉴权"></a> 3.第三步：鉴权</h5>
<p>用户访问资源需在请求头带上Authorization键，值为bearer+空格+accessToken，就能进入鉴权入口进行鉴权，鉴权通过之后即可访问资源</p>
<p><img src="https://pic.yupoo.com/zly1024/bf233602/8f3b9c35.png" alt="鉴权入口"></p>
<p><img src="https://pic.yupoo.com/zly1024/29b2d31c/2f3550b6.png" alt="鉴权_1"></p>
<p>然后使用Oauth2AuthenticationManager的authenticate方法鉴权认证</p>
<p><img src="https://pic.yupoo.com/zly1024/3ea97cdb/b8104731.png" alt="鉴权_2"></p>
<p>再进入DefaultTokenServices的loadAuthentication方法</p>
<p><img src="https://pic.yupoo.com/zly1024/830472f6/2b6f7bea.png" alt="鉴权_3"></p>
<p>1.执行jwtTokenStore–jwtAccessTokenConverter–DefaultAccessTokenConverter里d的方法extractAccessToken()并返回OAuth2AccessToken对象</p>
<p>2.执行jwtTokenStore–jwtAccessTokenConverter–DefaultAccessTokenConverter里的方法extractAuthentication()，并使用DefaultUserAuthenticationConverter的extractAuthentication方法(若配置了userDetailsService，则会去从数据库中获取角色，优先使用的时数据库返回的user和角色)返回UsernamePasswordAuthenticationToken对象</p>
<p>解析token方法</p>
<p><img src="https://pic.yupoo.com/zly1024/c7c519b4/c604949c.png" alt="鉴权_4"></p>
<p>鉴权认证通过之后，比对resourceIds和资源本身的resourceId</p>
<p><img src="https://pic.yupoo.com/zly1024/b90ce6fc/1a15bd95.png" alt="鉴权_5"></p>
<p>若比对成功则鉴权通过，可以访问到需访问的资源</p>
<p><img src="https://pic.yupoo.com/zly1024/cc172275/31d6abcc.png" alt="鉴权完成"></p>
</div></article><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/java/">java    </a><a class="post-meta__tags" href="/tags/框架/">框架    </a><a class="post-meta__tags" href="/tags/oauth/">oauth    </a></div><div class="post_share"><div class="social-share" data-image="/img/avatar.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-buttom"><i class="fa fa-qrcode"></i> Donate<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lozad post-qr-code__img" data-src="/img/wechat.jpg"><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lozad post-qr-code__img" data-src="/img/alipay.jpg"><div class="post-qr-code__desc">支付宝</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull-left"><a href="/2019/07/23/HEXO-新手搭建教程/"><img class="prev_cover lozad" data-src="https://pic.yupoo.com/zly1024/be738675/76a80b8d.jpg,https://pic.yupoo.com/zly1024/d4845b75/a2ba07a0.jpg,https://pic.yupoo.com/zly1024/9d08c53d/66826fcc.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="label">Previous Post</div><div class="prev_info"><span>HEXO 新手搭建教程</span></div></a></div><div class="next-post pull-right"><a href="/2019/07/22/hello-world/"><img class="next_cover lozad" data-src="https://pic.yupoo.com/zly1024/be738675/76a80b8d.jpg,https://pic.yupoo.com/zly1024/d4845b75/a2ba07a0.jpg,https://pic.yupoo.com/zly1024/9d08c53d/66826fcc.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="label">Next Post</div><div class="next_info"><span>Hello World</span></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-thumbs-up" aria-hidden="true"></i><span> Recommend</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2019/07/29/Android开发学习总结(一)/" title="Android开发学习总结(一)"><img class="relatedPosts_cover lozad" data-src="https://pic.yupoo.com/zly1024/be738675/76a80b8d.jpg"><div class="relatedPosts_title">Android开发学习总结(一)</div></a></div></div><div class="clear_both"></div></div><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i> <span>Comment</span></div><div class="vcomment" id="vcomment"></div><script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><script>var notify = 'false' == true ? true : false;
var verify = 'false' == true ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;

window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'',
  appKey:'',
  placeholder:'Please leave your footprints',
  avatar:'monsterid',
  guest_info:guest_info,
  pageSize:'10',
  lang:'zh-cn',
  recordIP: true
});</script></div></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2019 By 周凌宇</div><div class="footer_custom_text">主题转载自https://jerryc.me,侵删</div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><section class="rightside" id="rightside"><i class="fa fa-book" id="readmode" title="Read Mode"> </i><i class="fa fa-plus" id="font_plus" title="Increase font size"></i><i class="fa fa-minus" id="font_minus" title="Decrease font size"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="Traditional Chinese and Simplified Chinese Conversion">简</a><i class="fa fa-moon-o nightshift" id="nightshift" title="Dark Mode"></i></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script><script src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.css"><script src="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.css"><script>$(function () {
  $('span.katex-display').wrap('<div class="katex-wrap"></div>')
})</script><script async src="/js/search/local-search.js"></script><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="/js/third-party/fireworks.js"></script><script src="/js/nightshift.js"></script><script id="ribbon" src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/js/piao.js"></script><script src="/js/baidupush.js"> </script><script src="/js/activate-power-mode.js"></script><script>POWERMODE.colorful = true; // make power mode colorful
POWERMODE.shake = true; // turn off shake
document.body.addEventListener('input', POWERMODE);
</script><script src="/js/tw_cn.js"></script><script>translateInitilization()

</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@1.2.2/instantpage.min.js" type="module"></script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">Local search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>Powered by</span> <a href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>